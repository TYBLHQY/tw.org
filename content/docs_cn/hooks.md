---
title: "Taskwarrior - 钩子 v1"
---

## 钩子 v1

此处定义的 API 是 [钩子 v1] API。
后续版本将允许脚本确定正在使用哪个版本的钩子 API。

# 钩子

钩子系统是一种在 Taskwarrior 执行的特定点运行其他程序/脚本的方式，以便可以影响处理。
这些调用点对应于代码中发生某些关键处理的位置。
这些被称为*事件*。

钩子脚本与事件相关联。
当该事件发生时，所有关联的钩子脚本都会运行。
数据在 Taskwarrior 和钩子脚本之间交换。

钩子脚本可以用任何合适的编程语言编写。
典型的钩子脚本将读取数据、执行某些功能，然后写入数据和诊断信息并以状态代码退出。

钩子脚本不需要配置 - 它们的存在、可访问性和执行权限就足够了。

## 事件

钩子由事件触发，支持事件列表保持简短。

| 事件        | 说明                                                                                                                                                                                                                                           |
|-------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `on-launch` | 此事件在启动时触发，在所有数据结构初始化之后，但在任何处理之前。此事件提供了一个防止启动的机会。                                                                                      |
| `on-exit`   | 此事件在所有处理之后触发，但在输出显示之前立即触发，这是贡献脚注/错误的最后机会。此事件没有机会修改任务。                                    |
| `on-add`    | 创建新任务时触发此事件，在处理数据后但在保存任务之前。此事件提供了批准、拒绝或修改正在创建的任务的机会。                               |
| `on-modify` | 修改现有任务时触发此事件，在读取和处理数据后但在保存任务之前。此事件提供了批准、拒绝或进一步更改任务修改的机会。 |

任务完成和删除被认为是修改，由"状态"属性的更改指示。

## Git 模式

按照 Git 模式，钩子脚本只需在特定位置存在、拥有可识别的名称并具有执行权限即可运行。

钩子脚本的位置默认是 `~/.task/hooks`，它本身由 `rc.data.location` 设置定义，以及 `hooks` 子目录定义。
钩子脚本必须驻留在此位置，或以符号链接方式链接到此位置。
该位置本身可能是符号链接。
钩子脚本的名称应采用以下形式：

```
<event>[<identifier>]
```

一些例子：

```
on-add
on-add.01
on-add-require-project
```

脚本名称开头的事件将脚本与该事件相关联。
可选的标识符允许多个脚本与同一事件相关联。

当有多个脚本与同一事件相关联时，执行顺序是脚本名称的整理序列。
可以通过移除执行权限、重命名或将钩子脚本移到另一位置来禁用钩子脚本。

## 输入

钩子脚本的输入包含 JSON 格式的对象，每行一个，采用[Taskwarrior JSON 格式](https://github.com/GothenburgBitFactory/taskwarrior/blob/develop/doc/devel/rfcs/task.md)，这也由 [`export` 命令](../commands/export/)使用。

```
$ task 1 export
{"description":"Buy some milk","entry":"20141118T050231Z","status":"pending","uuid":"a360fc44-315c-4366-b70c-ea7e7520b749"}
```

上面的例子可能换行，但导出的 JSON 始终每行包含 1 个对象。
根据 JSON 标准，行内的空格是允许的，但任务*必须*仅占用一行输出。

## 输出

钩子脚本的输出是 JSON 格式的任务和文本的组合。
就像任务的 JSON 必须占用一行一样，单个反馈消息也必须。
对于成功的钩子脚本，反馈文本是可选的，但对于失败的脚本是必需的。
如果提供，将由 Taskwarrior 根据[冗长度设置](../verbosity/)显示。

这是一个假设的拼写检查钩子脚本的示例输出：

```
{"description":"Buy some milk","entry":"20141118T050231Z","status":"pending","uuid":"a360fc44-315c-4366-b70c-ea7e7520b749"}
Spell checking found no errors.
```

输出是单行 JSON 对象，表示可选修改的任务，以及要显示的单行反馈文本。

可能只有一行 JSON，并且它必须是为提供为输入的相同任务。

## 退出状态

钩子脚本可能以零状态退出，表示一切都很好。
发出的任务将被添加/修改，任何反馈将显示为脚注。

钩子脚本可能以非零状态退出，表示出现问题。
这会终止处理。
发出的所有任务都将被忽略。
在这种情况下反馈是必需的，将显示为错误。

## 接口

钩子脚本具有不同的责任，具体取决于钩子的类型。
某些提供了 JSON 输入，某些预期指示处理应继续还是停止。
所有可能提供错误消息。

| 事件       | 输入                         | 输出                  | 状态零 0                       | 状态非零                  |
|-------------|-------------------------------|-------------------------|-------------------------------------|----------------------------------|
| `on-launch` | 无                          | 无 JSON                 | 可选反馈变为脚注 | 必需的反馈变为错误 |
|             |                               | 反馈                | 处理继续                | 处理终止            |
| `on-exit`   | 针对添加/修改的任务的 JSON | 无 JSON                 | 可选反馈变为脚注 | 必需的反馈变为错误 | 
|             |                               | 反馈                |                                     |                                  | 
| `on-add`    | 针对添加的任务的 JSON           | 针对添加的任务的 JSON     | 针对添加的任务的 JSON                 | JSON 被忽略                     |
|             |                               | 反馈                | 可选反馈变为脚注 | 必需的反馈变为错误 | 
|             |                               |                         | 处理继续                | 处理终止            | 
| `on-modify` | 针对原始任务的 JSON        | 针对修改的任务的 JSON | 针对修改的任务的 JSON              | JSON 被忽略                     |
|             | 针对修改的任务的 JSON        | 反馈                | 可选反馈变为脚注 | 必需的反馈变为错误 |
|             |                               |                         | 处理继续                | 处理终止            |

这意味着 on-launch 钩子应该期望 0 行输入，on-exit 0 到多行，on-add 1，on-modify 2。

## 影响

钩子系统在几个地方可见：

- `diagnostics` 命令将列举钩子脚本，指示脚本是否可执行。
  这有助于诊断钩子问题。
- 在调试模式下（`rc.debug=1`），钩子调试模式（`rc.debug.hooks=1`）自动设置。
- 钩子有自己的调试模式。
  设置 `rc.debug.hooks=1` 将显示调用了哪个钩子脚本以及运行时间。
  这将帮助钩子脚本作者最小化其运行时间。
- 设置 `rc.debug.hooks=2` 也将显示钩子脚本的输入、输出和退出状态。

## 安全

对于任何钩子系统，都存在涉及竞态条件、无限循环和失控级联效应的潜在问题。
采取了各种措施来缓解这些问题：

- 格式错误的 JSON 被拒绝
- 正确的 JSON 但不是任务的 JSON 被 Taskwarrior 简单忽略

请注意：安装钩子脚本和安装任何软件一样危险，如果您不确定脚本的作用，请不要安装它。

## 示例

以下是钩子的一些示例用途。
此列表旨在作为灵感，可能不代表存在的实际脚本。

- 政策执行：参考问题、描述长度、项目值
- 影子文件
- 用户定义的特殊标签
- 自动优先级提升
- 自动数据备份
- 使某些任务只读
- 禁用功能，如循环或优先级
- 拼写检查
- 防止使用脏话
- 在启动时执行同步

Taskwarrior 附带了一些示例钩子脚本。
